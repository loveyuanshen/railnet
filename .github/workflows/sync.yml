name: Sync From Upstream (True Sync)

on:
  workflow_dispatch:
    inputs:
      confirm_sync:
        description: 'ç¡®è®¤åŒæ­¥ï¼Ÿè¾“å…¥ YES ç»§ç»­'
        required: true
        default: 'NO'

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_sync == 'YES'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
      
      - name: Add upstream and fetch
        run: |
          git remote add upstream https://github.com/Spr-Aachen/Twilight.git
          git fetch upstream
          
          # æ˜¾ç¤ºä¸Šæ¸¸å’Œæœ¬åœ°çš„å·®å¼‚
          echo "ðŸ“Š ä¸Šæ¸¸æœ€æ–°æäº¤ï¼š"
          git log --oneline upstream/main -5
          echo "ðŸ“Š æœ¬åœ°æœ€æ–°æäº¤ï¼š"
          git log --oneline HEAD -5
      
      - name: Backup custom content ONLY
        run: |
          echo "ðŸ”’ åªå¤‡ä»½è‡ªå®šä¹‰å†…å®¹..."
          mkdir -p .backup
          
          # åªå¤‡ä»½ç”¨æˆ·è‡ªå®šä¹‰å†…å®¹
          if [ -d "src/content" ]; then
            cp -r src/content .backup/
            echo "âœ… src/content å·²å¤‡ä»½"
          fi
          
          if [ -f "twilight.config.yaml" ]; then
            cp twilight.config.yaml .backup/
            echo "âœ… twilight.config.yaml å·²å¤‡ä»½"
          fi
          
          if [ -f ".env" ]; then
            cp .env .backup/
            echo "âœ… .env å·²å¤‡ä»½"
          fi
          
          # å¤‡ä»½publicä¸­çš„è‡ªå®šä¹‰æ–‡ä»¶ï¼ˆä¸æ˜¯å…¨éƒ¨ï¼‰
          if [ -d "public" ]; then
            mkdir -p .backup/public-custom
            # åªå¤‡ä»½ç”¨æˆ·å¯èƒ½è‡ªå®šä¹‰çš„æ–‡ä»¶
            find public -name "*.jpg" -o -name "*.png" -o -name "*.gif" -o -name "*.svg" | head -20 | xargs cp -t .backup/public-custom/ 2>/dev/null || true
            echo "âœ… è‡ªå®šä¹‰åª’ä½“æ–‡ä»¶å·²å¤‡ä»½"
          fi
      
      - name: TRUE SYNC: Replace with upstream files
        run: |
          echo "ðŸ”„ çœŸæ­£ä»Žä¸Šæ¸¸åŒæ­¥ï¼šæ›¿æ¢æ‰€æœ‰æ–‡ä»¶..."
          
          # æ–¹æ³•1ï¼šå®Œå…¨é‡ç½®åˆ°ä¸Šæ¸¸ï¼Œç„¶åŽæ¢å¤è‡ªå®šä¹‰å†…å®¹
          git reset --hard upstream/main
          echo "âœ… å·²é‡ç½®åˆ°ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬"
          
          # æ˜¾ç¤ºåŒæ­¥çš„æ–‡ä»¶åˆ—è¡¨
          echo "ðŸ“‹ åŒæ­¥çš„æ–‡ä»¶ï¼š"
          git diff HEAD~1 --name-only
      
      - name: Restore custom content
        run: |
          echo "ðŸ”’ æ¢å¤è‡ªå®šä¹‰å†…å®¹..."
          
          # æ¢å¤ç”¨æˆ·å†…å®¹
          if [ -d ".backup/content" ]; then
            cp -r .backup/content/* src/content/ 2>/dev/null || true
            echo "âœ… src/content å·²æ¢å¤"
          fi
          
          if [ -f ".backup/twilight.config.yaml" ]; then
            cp .backup/twilight.config.yaml twilight.config.yaml
            echo "âœ… twilight.config.yaml å·²æ¢å¤"
          fi
          
          if [ -f ".backup/.env" ]; then
            cp .backup/.env .env
            echo "âœ… .env å·²æ¢å¤"
          fi
          
          # æ¢å¤è‡ªå®šä¹‰åª’ä½“æ–‡ä»¶
          if [ -d ".backup/public-custom" ]; then
            cp -r .backup/public-custom/* public/ 2>/dev/null || true
            echo "âœ… è‡ªå®šä¹‰åª’ä½“æ–‡ä»¶å·²æ¢å¤"
          fi
      
      - name: Verify sync result
        run: |
          echo "ðŸ” éªŒè¯åŒæ­¥ç»“æžœ..."
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦æ¥è‡ªä¸Šæ¸¸
          echo "ðŸ“‹ æ£€æŸ¥å…³é”®æ–‡ä»¶ï¼š"
          
          # æ£€æŸ¥ CMS ç‰ˆæœ¬
          if grep -q "3.9.0" astro.config.mjs; then
            echo "âœ… Decap CMS ç‰ˆæœ¬å·²æ›´æ–°åˆ° 3.9.0"
          else
            echo "âŒ Decap CMS ç‰ˆæœ¬æ›´æ–°å¤±è´¥"
          fi
          
          # æ£€æŸ¥ ImageWrapper ç»„ä»¶
          if [ -f "src/components/common/imageWrapper.astro" ]; then
            echo "âœ… ImageWrapper ç»„ä»¶å·²åŒæ­¥"
          else
            echo "âŒ ImageWrapper ç»„ä»¶åŒæ­¥å¤±è´¥"
          fi
          
          # æ£€æŸ¥åª’ä½“ç›®å½•é…ç½®
          if grep -q "assets/images" public/admin/config.yml; then
            echo "âœ… åª’ä½“ç›®å½•é…ç½®å·²æ›´æ–°"
          else
            echo "âŒ åª’ä½“ç›®å½•é…ç½®æ›´æ–°å¤±è´¥"
          fi
          
          # æ£€æŸ¥è‡ªå®šä¹‰å†…å®¹æ˜¯å¦ä¿ç•™
          if [ -d "src/content/posts" ] || [ -d "src/content/diary" ]; then
            echo "âœ… è‡ªå®šä¹‰å†…å®¹å·²ä¿ç•™"
          else
            echo "âŒ è‡ªå®šä¹‰å†…å®¹ä¸¢å¤±"
          fi
      
      - name: Commit and push
        run: |
          git add .
          git commit -m "ä»Žä¸Šæ¸¸å®Œå…¨åŒæ­¥ (commit: $(git rev-parse upstream/main))

- åŒæ­¥ä¸Šæ¸¸æ‰€æœ‰æ›´æ–°
- ä¿ç•™è‡ªå®šä¹‰å†…å®¹
- æ›´æ–°åˆ°ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬" || {
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          }
          git push origin main
      
      - name: Summary
        run: |
          echo "## ðŸ“Š çœŸæ­£ä»Žä¸Šæ¸¸åŒæ­¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… åŒæ­¥æ–¹å¼" >> $GITHUB_STEP_SUMMARY
          echo "- å®Œå…¨é‡ç½®åˆ°ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
          echo "- æ¢å¤è‡ªå®šä¹‰å†…å®¹" >> $GITHUB_STEP_SUMMARY
          echo "- æ‰€æœ‰æ–‡ä»¶éƒ½æ¥è‡ªä¸Šæ¸¸åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ ä¸Šæ¸¸æäº¤ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- æäº¤å“ˆå¸Œ: $(git rev-parse upstream/main)" >> $GITHUB_STEP_SUMMARY
          echo "- æäº¤æ¶ˆæ¯: $(git log -1 --pretty=format:'%s' upstream/main)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”’ ä¿æŠ¤çš„å†…å®¹" >> $GITHUB_STEP_SUMMARY
          echo "- src/content (æ‰€æœ‰è‡ªå®šä¹‰æ–‡ç« å’Œé¡µé¢)" >> $GITHUB_STEP_SUMMARY
          echo "- twilight.config.yaml (ä¸ªäººé…ç½®)" >> $GITHUB_STEP_SUMMARY
          echo "- .env (çŽ¯å¢ƒå˜é‡)" >> $GITHUB_STEP_SUMMARY
          echo "- è‡ªå®šä¹‰åª’ä½“æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
