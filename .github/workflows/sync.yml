name: Sync Twilight Updates

on:
  workflow_dispatch:
    inputs:
      confirm_sync:
        description: 'ç¡®è®¤åŒæ­¥ï¼Ÿè¾“å…¥ YES ç»§ç»­'
        required: true
        default: 'NO'

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_sync == 'YES'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
      
      - name: Add upstream
        run: |
          git remote add upstream https://github.com/Spr-Aachen/Twilight.git
          git fetch upstream
      
      - name: Check updates
        id: check
        run: |
          LOCAL=$(git rev-parse HEAD)
          UPSTREAM=$(git rev-parse upstream/main)
          
          if [ "$LOCAL" = "$UPSTREAM" ]; then
            echo "already_latest=true" >> $GITHUB_OUTPUT
            echo "âœ… æœ¬åœ°å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
          else
            echo "already_latest=false" >> $GITHUB_OUTPUT
            echo "ðŸ”„ å‘çŽ°æ›´æ–°ï¼Œå‡†å¤‡åŒæ­¥"
            echo "æœ¬åœ°: $LOCAL"
            echo "ä¸Šæ¸¸: $UPSTREAM"
          fi
      
      - name: Backup important files
        if: steps.check.outputs.already_latest == 'false'
        run: |
          echo "ðŸ”’ å¤‡ä»½é‡è¦æ–‡ä»¶..."
          mkdir -p .backup
          
          # å¤‡ä»½å†…å®¹ç›®å½•
          if [ -d "src/content" ]; then
            cp -r src/content .backup/
            echo "âœ… src/content å·²å¤‡ä»½"
          fi
          
          # å¤‡ä»½é…ç½®æ–‡ä»¶
          if [ -f "twilight.config.yaml" ]; then
            cp twilight.config.yaml .backup/
            echo "âœ… twilight.config.yaml å·²å¤‡ä»½"
          fi
          
          # å¤‡ä»½çŽ¯å¢ƒå˜é‡
          if [ -f ".env" ]; then
            cp .env .backup/
            echo "âœ… .env å·²å¤‡ä»½"
          fi
      
      - name: Sync updates
        if: steps.check.outputs.already_latest == 'false'
        run: |
          echo "ðŸ”„ å¼€å§‹åŒæ­¥ä¸Šæ¸¸æ›´æ–°..."
          
          # å°è¯•åˆå¹¶
          if git merge upstream/main --allow-unrelated-histories --no-edit; then
            echo "âœ… åˆå¹¶æˆåŠŸ"
          else
            echo "âŒ åˆå¹¶å†²çªï¼Œæ¢å¤å¤‡ä»½æ–‡ä»¶"
            
            # æ¢å¤å¤‡ä»½
            if [ -d ".backup/content" ]; then
              rm -rf src/content
              cp -r .backup/content src/
            fi
            
            if [ -f ".backup/twilight.config.yaml" ]; then
              cp .backup/twilight.config.yaml twilight.config.yaml
            fi
            
            if [ -f ".backup/.env" ]; then
              cp .backup/.env .env
            fi
            
            echo "ðŸ”’ å·²æ¢å¤ä½ çš„è‡ªå®šä¹‰æ–‡ä»¶"
            exit 1
          fi
      
      - name: Restore custom files
        if: steps.check.outputs.already_latest == 'false'
        run: |
          echo "ðŸ”’ æ¢å¤è‡ªå®šä¹‰æ–‡ä»¶..."
          
          # æ¢å¤å†…å®¹ç›®å½•
          if [ -d ".backup/content" ]; then
            rm -rf src/content
            cp -r .backup/content src/
            echo "âœ… src/content å·²æ¢å¤"
          fi
          
          # æ¢å¤é…ç½®æ–‡ä»¶ï¼ˆä¿ç•™ä½ çš„è‡ªå®šä¹‰é…ç½®ï¼‰
          if [ -f ".backup/twilight.config.yaml" ]; then
            cp .backup/twilight.config.yaml twilight.config.yaml
            echo "âœ… twilight.config.yaml å·²æ¢å¤"
          fi
          
          # æäº¤æ¢å¤çš„æ–‡ä»¶
          git add src/content twilight.config.yaml
          git commit -m "æ¢å¤è‡ªå®šä¹‰å†…å®¹" || echo "æ— éœ€æäº¤æ¢å¤æ–‡ä»¶"
      
      - name: Push changes
        if: steps.check.outputs.already_latest == 'false'
        run: |
          git push origin main
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š åŒæ­¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check.outputs.already_latest }}" == "true" ]; then
            echo "âœ… **çŠ¶æ€**: æœ¬åœ°å·²æ˜¯æœ€æ–°ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ”„ **çŠ¶æ€**: åŒæ­¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”’ **ä¿æŠ¤**: src/content å’Œ twilight.config.yaml å·²ä¿æŠ¤" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ **å»ºè®®**: æœ¬åœ°è¿è¡Œ \`pnpm dev\` æµ‹è¯•åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
          fi
