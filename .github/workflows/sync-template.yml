name: ğŸ” Sync with Template Repository

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤© UTC æ—¶é—´ 4:00 æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 12:00ï¼‰
  schedule:
    - cron: "0 4 * * *"
  
  # æ‰‹åŠ¨è§¦å‘ï¼šå¯ä»¥åœ¨ GitHub Actions ç•Œé¢æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
    inputs:
      template_branch:
        description: 'Template branch to sync from'
        required: false
        default: 'main'

# åªæœ‰åœ¨é»˜è®¤åˆ†æ”¯ä¸Šè¿è¡Œå®šæ—¶ä»»åŠ¡
jobs:
  sync-template:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ğŸ›ï¸ Checkout current repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´å†å²

      - name: ğŸ“¥ Set up Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ¯ Get template repository info
        id: template_info
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "TEMPLATE_REPO=Spr-Aachen/Twilight" >> $GITHUB_ENV
            echo "TEMPLATE_BRANCH=${{ github.event.inputs.template_branch }}" >> $GITHUB_ENV
          else
            echo "TEMPLATE_REPO=Spr-Aachen/Twilight" >> $GITHUB_ENV
            echo "TEMPLATE_BRANCH=main" >> $GITHUB_ENV
          fi

      - name: ğŸ”— Add template repository as remote
        run: |
          git remote add template https://github.com/${{ env.TEMPLATE_REPO }}.git

      - name: ğŸ“¥ Fetch template repository
        run: |
          git fetch template ${{ env.TEMPLATE_BRANCH }}

      - name: ğŸ”„ Check if there are new commits
        id: check_commits
        run: |
          # æ¯”è¾ƒå½“å‰åˆ†æ”¯å’Œæ¨¡æ¿åˆ†æ”¯çš„æœ€æ–°æäº¤
          LOCAL_COMMIT=$(git rev-parse HEAD)
          TEMPLATE_COMMIT=$(git rev-parse template/${{ env.TEMPLATE_BRANCH }})
          
          if [ "$LOCAL_COMMIT" = "$TEMPLATE_COMMIT" ]; then
            echo "No new commits in template repository"
            echo "HAS_NEW_COMMITS=false" >> $GITHUB_ENV
          else
            echo "New commits found in template repository"
            echo "HAS_NEW_COMMITS=true" >> $GITHUB_ENV
            echo "TEMPLATE_COMMIT=$TEMPLATE_COMMIT" >> $GITHUB_ENV
            # åˆ›å»ºçŸ­ç‰ˆæœ¬çš„ commit hash
            echo "TEMPLATE_COMMIT_SHORT=$(echo $TEMPLATE_COMMIT | cut -c1-8)" >> $GITHUB_ENV
          fi

      - name: ğŸš« Skip if no new commits
        if: env.HAS_NEW_COMMITS == 'false'
        run: |
          echo "âœ… Template is already up to date"
          exit 0

      - name: ğŸŒ¿ Create sync branch
        run: |
          git checkout -b template-sync-${{ env.TEMPLATE_COMMIT_SHORT }}

      - name: ğŸ¤ Merge template changes
        run: |
          # ä½¿ç”¨ --allow-unrelated-histories å› ä¸ºè¿™æ˜¯æ¨¡æ¿ä»“åº“
          git merge template/${{ env.TEMPLATE_BRANCH }} --allow-unrelated-histories -m "chore: sync with template ${{ env.TEMPLATE_COMMIT_SHORT }}"

      - name: ğŸ“¤ Push sync branch
        run: |
          git push origin template-sync-${{ env.TEMPLATE_COMMIT_SHORT }}

      - name: ğŸ“ Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: template-sync-${{ env.TEMPLATE_COMMIT_SHORT }}
          base: ${{ github.ref_name }}
          title: 'ğŸ”„ Sync with Twilight template repository'
          body: |
            This PR syncs changes from the Twilight template repository [Spr-Aachen/Twilight](https://github.com/Spr-Aachen/Twilight).
            
            **Template commit:** `${{ env.TEMPLATE_COMMIT }}`
            
            Please review the changes before merging.
            
            ---
            
            *This PR was automatically created by the sync workflow.*
          labels: |
            sync
            template
          reviewers: ''
          assignees: ''
