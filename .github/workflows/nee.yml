name: Sync Content Management Updates

on:
  workflow_dispatch:
    inputs:
      update_cms:
        description: 'æ›´æ–°CMSé…ç½®ï¼Ÿ'
        required: true
        default: 'true'
        type: boolean
      update_media:
        description: 'æ›´æ–°åª’ä½“ç›®å½•ç»“æ„ï¼Ÿ'
        required: true
        default: 'true'
        type: boolean
      update_components:
        description: 'æ›´æ–°å›¾ç‰‡ç»„ä»¶ï¼Ÿ'
        required: true
        default: 'true'
        type: boolean
      confirm_sync:
        description: 'ç¡®è®¤åŒæ­¥ï¼Ÿè¾“å…¥ YES ç»§ç»­'
        required: true
        default: 'NO'

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_sync == 'YES'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
      
      - name: Add upstream
        run: |
          git remote add upstream https://github.com/Spr-Aachen/Twilight.git
          git fetch upstream
      
      - name: Backup custom content
        run: |
          echo "ğŸ”’ å¤‡ä»½è‡ªå®šä¹‰å†…å®¹..."
          mkdir -p .backup
          
          # å¤‡ä»½æ‰€æœ‰å†…å®¹
          if [ -d "src/content" ]; then
            cp -r src/content .backup/
            echo "âœ… src/content å·²å¤‡ä»½"
          fi
          
          # å¤‡ä»½é…ç½®
          if [ -f "twilight.config.yaml" ]; then
            cp twilight.config.yaml .backup/
            echo "âœ… twilight.config.yaml å·²å¤‡ä»½"
          fi
          
          if [ -f ".env" ]; then
            cp .env .backup/
            echo "âœ… .env å·²å¤‡ä»½"
          fi
          
          if [ -d "public" ]; then
            cp -r public .backup/
            echo "âœ… public ç›®å½•å·²å¤‡ä»½"
          fi
      
      - name: Update Decap CMS Configuration
        if: github.event.inputs.update_cms == 'true'
        run: |
          echo "ğŸ”„ æ›´æ–° Decap CMS é…ç½®..."
          
          # æ›´æ–° astro.config.mjs ä¸­çš„ç‰ˆæœ¬
          if [ -f "astro.config.mjs" ]; then
            sed -i 's/decapCMSVersion: "3.3.3"/decapCMSVersion: "3.9.0"/' astro.config.mjs
            echo "âœ… astro.config.mjs å·²æ›´æ–°"
          fi
          
          # æ›´æ–° .env æ–‡ä»¶ï¼ˆç§»é™¤æ—§çš„CMSé…ç½®ï¼‰
          if [ -f ".env" ]; then
            # ç§»é™¤æ—§çš„CMSé…ç½®è¡Œ
            sed -i '/# Decap CMS/,/PUBLIC_DECAP_CMS_VERSION=3.3.3/d' .env
            echo "âœ… .env å·²æ¸…ç†"
          fi
          
          # æ›´æ–° CMS é…ç½®æ–‡ä»¶
          if [ -f "public/admin/config.yml" ]; then
            # æ·»åŠ è¯­è¨€è®¾ç½®
            if ! grep -q "locale:" public/admin/config.yml; then
              sed -i '/auth_endpoint: oauth/a\\n\\n# è®¾ç½®åå°ç³»ç»Ÿè¯­è¨€ (zh_Hans ç®€ä½“ä¸­æ–‡ | en è‹±æ–‡ | ...)\\nlocale: en' public/admin/config.yml
            fi
            
            # æ›´æ–°åª’ä½“ç›®å½•é…ç½®
            sed -i 's|media_folder: "public/images"|media_folder: "public/assets/images"|' public/admin/config.yml
            sed -i 's|public_folder: "/images"|public_folder: "/assets/images"|' public/admin/config.yml
            
            echo "âœ… public/admin/config.yml å·²æ›´æ–°"
          fi
      
      - name: Update Media Directory Structure
        if: github.event.inputs.update_media == 'true'
        run: |
          echo "ğŸ”„ æ›´æ–°åª’ä½“ç›®å½•ç»“æ„..."
          
          # åˆ›å»ºæ–°çš„åª’ä½“ç›®å½•
          mkdir -p public/assets/images
          
          # ç§»åŠ¨ç°æœ‰å›¾ç‰‡åˆ°æ–°ç›®å½•
          if [ -d "public/images" ] && [ "$(ls -A public/images)" ]; then
            echo "ç§»åŠ¨ç°æœ‰å›¾ç‰‡åˆ°æ–°ç›®å½•..."
            cp -r public/images/* public/assets/images/ 2>/dev/null || true
            echo "âœ… å›¾ç‰‡å·²ç§»åŠ¨åˆ°æ–°ç›®å½•"
          fi
          
          # æ›´æ–°å†…å®¹ä¸­çš„å›¾ç‰‡è·¯å¾„
          find src/content -name "*.md" -o -name "*.json" | while read file; do
            sed -i 's|/images/|/assets/images/|g' "$file"
          done
          echo "âœ… å†…å®¹ä¸­çš„å›¾ç‰‡è·¯å¾„å·²æ›´æ–°"
      
      - name: Update Image Components
        if: github.event.inputs.update_components == 'true'
        run: |
          echo "ğŸ”„ æ›´æ–°å›¾ç‰‡ç»„ä»¶..."
          
          # è·å–ä¸Šæ¸¸çš„ ImageWrapper ç»„ä»¶
          if [ -f "upstream/main/src/components/common/imageWrapper.astro" ]; then
            mkdir -p src/components/common
            cp upstream/main/src/components/common/imageWrapper.astro src/components/common/
            echo "âœ… ImageWrapper ç»„ä»¶å·²æ·»åŠ "
          fi
          
          # æ›´æ–° projectCard.astro
          if [ -f "src/components/data/projectCard.astro" ]; then
            # æ·»åŠ  ImageWrapper å¯¼å…¥
            if ! grep -q "ImageWrapper" src/components/data/projectCard.astro; then
              sed -i '/import I18nKey from "@i18n\/i18nKey";/a import ImageWrapper from "@components/common/imageWrapper.astro";' src/components/data/projectCard.astro
            fi
            
            # æ·»åŠ  basePath å±æ€§
            if ! grep -q "basePath?:" src/components/data/projectCard.astro; then
              sed -i '/tags?: string\[\];/a \  basePath?: string;' src/components/data/projectCard.astro
            fi
            
            # æ›¿æ¢ img æ ‡ç­¾ä¸º ImageWrapper
            sed -i 's|<img|<ImageWrapp
