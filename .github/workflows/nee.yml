name: Sync Content Management Updates

on:
  workflow_dispatch:
    inputs:
      update_cms:
        description: 'æ›´æ–°CMSé…ç½®ï¼Ÿ'
        required: true
        default: 'true'
        type: boolean
      update_media:
        description: 'æ›´æ–°åª’ä½“ç›®å½•ç»“æ„ï¼Ÿ'
        required: true
        default: 'true'
        type: boolean
      update_components:
        description: 'æ›´æ–°å›¾ç‰‡ç»„ä»¶ï¼Ÿ'
        required: true
        default: 'true'
        type: boolean
      confirm_sync:
        description: 'ç¡®è®¤åŒæ­¥ï¼Ÿè¾“å…¥ YES ç»§ç»­'
        required: true
        default: 'NO'

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_sync == 'YES'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
      
      - name: Add upstream
        run: |
          git remote add upstream https://github.com/Spr-Aachen/Twilight.git
          git fetch upstream
      
      - name: Backup custom content
        run: |
          echo "ğŸ”’ å¤‡ä»½è‡ªå®šä¹‰å†…å®¹..."
          mkdir -p .backup
          
          # å¤‡ä»½æ‰€æœ‰å†…å®¹
          if [ -d "src/content" ]; then
            cp -r src/content .backup/
            echo "âœ… src/content å·²å¤‡ä»½"
          fi
          
          # å¤‡ä»½é…ç½®
          if [ -f "twilight.config.yaml" ]; then
            cp twilight.config.yaml .backup/
            echo "âœ… twilight.config.yaml å·²å¤‡ä»½"
          fi
          
          if [ -f ".env" ]; then
            cp .env .backup/
            echo "âœ… .env å·²å¤‡ä»½"
          fi
          
          if [ -d "public" ]; then
            cp -r public .backup/
            echo "âœ… public ç›®å½•å·²å¤‡ä»½"
          fi
      
      - name: Update Decap CMS Configuration
        if: github.event.inputs.update_cms == 'true'
        run: |
          echo "ğŸ”„ æ›´æ–° Decap CMS é…ç½®..."
          
          # æ›´æ–° astro.config.mjs ä¸­çš„ç‰ˆæœ¬
          if [ -f "astro.config.mjs" ]; then
            sed -i 's/decapCMSVersion: "3.3.3"/decapCMSVersion: "3.9.0"/' astro.config.mjs
            echo "âœ… astro.config.mjs å·²æ›´æ–°"
          fi
          
          # æ›´æ–° .env æ–‡ä»¶ï¼ˆç§»é™¤æ—§çš„CMSé…ç½®ï¼‰
          if [ -f ".env" ]; then
            # ç§»é™¤æ—§çš„CMSé…ç½®è¡Œ
            sed -i '/# Decap CMS/,/PUBLIC_DECAP_CMS_VERSION=3.3.3/d' .env
            echo "âœ… .env å·²æ¸…ç†"
          fi
          
          # æ›´æ–° CMS é…ç½®æ–‡ä»¶
          if [ -f "public/admin/config.yml" ]; then
            # æ·»åŠ è¯­è¨€è®¾ç½®
            if ! grep -q "locale:" public/admin/config.yml; then
              sed -i '/auth_endpoint: oauth/a\\n\\n# è®¾ç½®åå°ç³»ç»Ÿè¯­è¨€ (zh_Hans ç®€ä½“ä¸­æ–‡ | en è‹±æ–‡ | ...)\\nlocale: en' public/admin/config.yml
            fi
            
            # æ›´æ–°åª’ä½“ç›®å½•é…ç½®
            sed -i 's|media_folder: "public/images"|media_folder: "public/assets/images"|' public/admin/config.yml
            sed -i 's|public_folder: "/images"|public_folder: "/assets/images"|' public/admin/config.yml
            
            echo "âœ… public/admin/config.yml å·²æ›´æ–°"
          fi
      
      - name: Update Media Directory Structure
        if: github.event.inputs.update_media == 'true'
        run: |
          echo "ğŸ”„ æ›´æ–°åª’ä½“ç›®å½•ç»“æ„..."
          
          # åˆ›å»ºæ–°çš„åª’ä½“ç›®å½•
          mkdir -p public/assets/images
          
          # ç§»åŠ¨ç°æœ‰å›¾ç‰‡åˆ°æ–°ç›®å½•
          if [ -d "public/images" ] && [ "$(ls -A public/images)" ]; then
            echo "ç§»åŠ¨ç°æœ‰å›¾ç‰‡åˆ°æ–°ç›®å½•..."
            cp -r public/images/* public/assets/images/ 2>/dev/null || true
            echo "âœ… å›¾ç‰‡å·²ç§»åŠ¨åˆ°æ–°ç›®å½•"
          fi
          
          # æ›´æ–°å†…å®¹ä¸­çš„å›¾ç‰‡è·¯å¾„
          find src/content -name "*.md" -o -name "*.json" | while read file; do
            sed -i 's|/images/|/assets/images/|g' "$file"
          done
          echo "âœ… å†…å®¹ä¸­çš„å›¾ç‰‡è·¯å¾„å·²æ›´æ–°"
      
      - name: Update Image Components
        if: github.event.inputs.update_components == 'true'
        run: |
          echo "ğŸ”„ æ›´æ–°å›¾ç‰‡ç»„ä»¶..."
          
          # è·å–ä¸Šæ¸¸çš„ ImageWrapper ç»„ä»¶
          if [ -f "upstream/main/src/components/common/imageWrapper.astro" ]; then
            mkdir -p src/components/common
            cp upstream/main/src/components/common/imageWrapper.astro src/components/common/
            echo "âœ… ImageWrapper ç»„ä»¶å·²æ·»åŠ "
          fi
          
          # æ›´æ–° projectCard.astro
          if [ -f "src/components/data/projectCard.astro" ]; then
            # æ·»åŠ  ImageWrapper å¯¼å…¥
            if ! grep -q "ImageWrapper" src/components/data/projectCard.astro; then
              sed -i '/import I18nKey from "@i18n\/i18nKey";/a import ImageWrapper from "@components/common/imageWrapper.astro";' src/components/data/projectCard.astro
            fi
            
            # æ·»åŠ  basePath å±æ€§
            if ! grep -q "basePath?:" src/components/data/projectCard.astro; then
              sed -i '/tags?: string\[\];/a \  basePath?: string;' src/components/data/projectCard.astro
            fi
            
            # æ›¿æ¢ img æ ‡ç­¾ä¸º ImageWrapper
            sed -i 's|<img|<ImageWrapper|g' src/components/data/projectCard.astro
            sed -i 's|/>|/>|g' src/components/data/projectCard.astro
            sed -i 's|loading="lazy"|basePath={project.basePath}|g' src/components/data/projectCard.astro
            
            echo "âœ… projectCard.astro å·²æ›´æ–°"
          fi
          
          # æ›´æ–°ç›¸å†Œé¡µé¢ç»„ä»¶
          for page in src/pages/albums.astro src/pages/albums/\[id\]/index.astro; do
            if [ -f "$page" ]; then
              # æ·»åŠ  ImageWrapper å¯¼å…¥
              if ! grep -q "ImageWrapper" "$page"; then
                sed -i '/import BackwardButton/a import ImageWrapper from "@components/common/imageWrapper.astro";' "$page"
              fi
              
              # æ›¿æ¢ img æ ‡ç­¾
              sed -i 's|<img|<ImageWrapper|g' "$page"
              sed -i 's|loading="lazy"|basePath={album.basePath}|g' "$page"
              
              echo "âœ… $page å·²æ›´æ–°"
            fi
          done
      
      - name: Restore Custom Content
        run: |
          echo "ğŸ”’ æ¢å¤è‡ªå®šä¹‰å†…å®¹..."
          
          # æ¢å¤å†…å®¹ç›®å½•ï¼ˆä¿ç•™ç»“æ„æ›´æ–°ï¼‰
          if [ -d ".backup/content" ]; then
            # å…ˆæ¢å¤ï¼Œç„¶ååº”ç”¨æ–°çš„ç»“æ„
            cp -r .backup/content/* src/content/ 2>/dev/null || true
            
            # ç¡®ä¿æ–°çš„ç¤ºä¾‹æ–‡ä»¶å­˜åœ¨ï¼ˆå¦‚æœä¸Šæ¸¸æœ‰ï¼‰
            if [ -f "upstream/main/src/content/diary/example.json" ] && [ ! -f "src/content/diary/example.json" ]; then
              cp upstream/main/src/content/diary/example.json src/content/diary/
            fi
            
            echo "âœ… å†…å®¹å·²æ¢å¤å¹¶æ›´æ–°"
          fi
          
          # æ¢å¤é…ç½®æ–‡ä»¶
          if [ -f ".backup/twilight.config.yaml" ]; then
            cp .backup/twilight.config.yaml twilight.config.yaml
            echo "âœ… twilight.config.yaml å·²æ¢å¤"
          fi
      
      - name: Update Dependencies
        run: |
          echo "ğŸ”„ æ›´æ–°ä¾èµ–..."
          
          # æ›´æ–° package.json ä¸­çš„ä¾èµ–ç‰ˆæœ¬
          if [ -f "upstream/main/package.json" ]; then
            # ä½¿ç”¨æ›´ç®€å•çš„æ–¹æ³•æ›´æ–°å…³é”®ä¾èµ–
            node -e "
              const fs = require('fs');
              const local = JSON.parse(fs.readFileSync('./package.json', 'utf8'));
              const upstream = JSON.parse(fs.readFileSync('./upstream/main/package.json', 'utf8'));
              
              ['dependencies', 'devDependencies'].forEach(type => {
                if (upstream[type]) {
                  Object.keys(upstream[type]).forEach(pkg => {
                    if (local[type] && local[type][pkg] && local[type][pkg] !== upstream[type][pkg]) {
                      console.log('æ›´æ–°', pkg, 'ä»', local[type][pkg], 'åˆ°', upstream[type][pkg]);
                      local[type][pkg] = upstream[type][pkg];
                    }
                  });
                }
              });
              
              fs.writeFileSync('./package.json', JSON.stringify(local, null, 2));
            " || echo "ä¾èµ–æ›´æ–°è·³è¿‡"
            echo "âœ… package.json å·²æ£€æŸ¥"
          fi
      
      - name: Commit and Push
        run: |
          git add .
          git commit -m "æ›´æ–°å†…å®¹ç®¡ç†ç³»ç»Ÿ (PR #73)

- å‡çº§ Decap CMS åˆ° 3.9.0
- é‡æ„åª’ä½“ç›®å½•ç»“æ„ (/images â†’ /assets/images)
- æ–°å¢ ImageWrapper ç»„ä»¶
- ä¼˜åŒ–å›¾ç‰‡å¤„ç†
- æ›´æ–° CMS é…ç½®æ”¯æŒåµŒå¥—ç›®å½•" || {
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          }
          git push origin main
      
      - name: Summary
        run: |
          echo "## ğŸ“Š å†…å®¹ç®¡ç†æ›´æ–°å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… å·²å®Œæˆçš„æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "- Decap CMS ç‰ˆæœ¬å‡çº§ (3.3.3 â†’ 3.9.0)" >> $GITHUB_STEP_SUMMARY
          echo "- åª’ä½“ç›®å½•é‡æ„ (/images â†’ /assets/images)" >> $GITHUB_STEP_SUMMARY
          echo "- æ–°å¢ ImageWrapper å›¾ç‰‡ç»„ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- CMS é…ç½®å¢å¼º" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”’ ä¿æŠ¤çš„å†…å®¹" >> $GITHUB_STEP_SUMMARY
          echo "- æ‰€æœ‰è‡ªå®šä¹‰æ–‡ç« å’Œé¡µé¢" >> $GITHUB_STEP_SUMMARY
          echo "- ä¸ªäººé…ç½®æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- è‡ªå®šä¹‰åª’ä½“æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ åç»­æ­¥éª¤" >> $GITHUB_STEP_SUMMARY
          echo "1. æœ¬åœ°è¿è¡Œ \`pnpm install\` æ›´æ–°ä¾èµ–" >> $GITHUB_STEP_SUMMARY
          echo "2. æ£€æŸ¥ CMS åå°åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
          echo "3. éªŒè¯å›¾ç‰‡æ˜¾ç¤ºæ­£å¸¸" >> $GITHUB_STEP_SUMMARY
          echo "4. æµ‹è¯•æ–°çš„åª’ä½“ç›®å½•ç»“æ„" >> $GITHUB_STEP_SUMMARY
